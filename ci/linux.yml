# Linux-specific:
steps:
  - checkout: self
    submodules: true

  - task: AzureKeyVault@2
    inputs:
      azureSubscription: 'Azure pay as you go subscription(536e7fb0-2ead-4833-bd2c-c8bcf1fc41a7)'
      KeyVaultName: 'CIPipelineKeyVault'
      SecretsFilter: '*'
      RunAsPreJob: true

  - script: | 
      echo Hello, Azure agent is now installing the necessary build tools...!
      cd $(Build.BinariesDirectory)
      wget https://download.qt.io/official_releases/online_installers/qt-unified-linux-x64-online.run
      chmod 755 qt-unified-linux-x64-online.run
      ./qt-unified-linux-x64-online.run install qt.qt5.5150.gcc_64 qt.qt5.5150.qtcore qt.qt5.5150.qtgui qt.qt5.5150.qtquick qt.qt5.5150.qtqml qt.tools.ifw.41 --root $(Build.BinariesDirectory)/Qt --auto-answer telemetry-question=Yes,AssociateCommonFiletypes=Yes --default-answer --accept-licenses --accept-obligations --file-query --email "hemanth_kumar.guntamadugu@sandvik.com" --pw "$(QtPassword)" --confirm-command
    displayName: 'Install Qt Commercial'

  - script: | 
      echo Hello, Azure agent is now compiling the sources from pipeline!
      cd $(Build.SourcesDirectory)\\sources
      mkdir build
      cd build
      $(Build.BinariesDirectory)\\Qt\\5.15.0\\gcc_64\\bin\\qmake.exe ../Crypto_QML_GUI.pro
      make
    displayName: 'Compiling the source code...!'

# Task to run the automated tests this might be migrated to Release Pipeline and here only concentrate on the Units tests
#- task: SquishTask@1
#  inputs:
#    squishFolder: '/Applications/Squish for Qt 6.7.1'
#    squishTestSuites: '/Users/ghkraju/Documents/Projects/Qt_QML_GUI/TestSuite/suite_QML_GUI'
#    squishReportGenTestcenter: true
#    squishTestcenterURL: 'http://localhost:8800'
#    squishTestcenterProject: 'QML_GUI'
#    squishTestcenterToken: 'ccl6SFLAIBC4HMZHPH6eMIdYA9W6dMHh9WYCFRcbpWc'

#- task: SquishTestcenterTask@1
#  inputs:
#    squishTestcenterURL: 'http://localhost:8800'
#    squishTestcenterProject: 'QML_GUI'

  - task: CopyFiles@2
    inputs:
      SourceFolder: 'Crypto_QML_GUI/build'
      Contents: '**'
      TargetFolder: '$(Build.ArtifactStagingDirectory)'
      CleanTargetFolder: true

  - task: UniversalPackages@0
    inputs:
      command: 'publish'
      publishDirectory: '$(Build.ArtifactStagingDirectory)'
      feedsToUsePublish: 'internal'
      vstsFeedPublish: 'd9e18571-4868-4836-a3ec-5f9dd2594d30'
      vstsFeedPackagePublish: 'crypto_qml_gui'
      versionOption: 'minor'

  - script: | 
      echo Removing all the installed binaries for the build!
      cd $(Build.BinariesDirectory)\\Qt
      .\MaintenanceTool.exe purge
      cd $(Build.BinariesDirectory)
      rm -r *
    condition: always()
    displayName: 'Reset Binaries directory'